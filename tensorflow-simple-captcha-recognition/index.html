<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用 TensorFlow 识别简单图像验证码 | 洋子的自留地</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="alternate" type="application/rss+xml" href="https://purocean.github.io/rss.xml" title="洋子的自留地 RSS Feed">
    <meta name="description" content="公司有一个业务需要抓取某网站数据，登录需要识别验证码，类似下面这种，这应该是很多网站使用的验证码类型。

首先由于验证码比较简单，图像不复杂，而且全部是数字。于是试着采用传统方式，按照网上教程自己简单改了一个，使用 PHP 识别。大概流程就是切割二值化去噪等预处理 ...">
    
    <link rel="preload" href="/assets/css/0.styles.5ee86e3d.css" as="style"><link rel="preload" href="/assets/js/app.eb9f9003.js" as="script"><link rel="preload" href="/assets/js/4.a919a368.js" as="script"><link rel="preload" href="/assets/js/1.b0bbcc77.js" as="script"><link rel="preload" href="/assets/js/16.846050e5.js" as="script"><link rel="prefetch" href="/assets/js/11.8d29bb1f.js"><link rel="prefetch" href="/assets/js/12.ebc662de.js"><link rel="prefetch" href="/assets/js/13.ed891f49.js"><link rel="prefetch" href="/assets/js/14.9d2f201d.js"><link rel="prefetch" href="/assets/js/15.54f4a3d9.js"><link rel="prefetch" href="/assets/js/17.c6a2bbc8.js"><link rel="prefetch" href="/assets/js/18.66fb8bc7.js"><link rel="prefetch" href="/assets/js/19.a70e5f6f.js"><link rel="prefetch" href="/assets/js/2.d9736519.js"><link rel="prefetch" href="/assets/js/20.d5dd728f.js"><link rel="prefetch" href="/assets/js/21.3f30521e.js"><link rel="prefetch" href="/assets/js/22.66343f4a.js"><link rel="prefetch" href="/assets/js/23.c176132e.js"><link rel="prefetch" href="/assets/js/24.69166df7.js"><link rel="prefetch" href="/assets/js/25.b5c2c5f1.js"><link rel="prefetch" href="/assets/js/26.a3e36f84.js"><link rel="prefetch" href="/assets/js/27.8ad76597.js"><link rel="prefetch" href="/assets/js/28.2b42ab80.js"><link rel="prefetch" href="/assets/js/29.efaefbb5.js"><link rel="prefetch" href="/assets/js/3.605ef2e9.js"><link rel="prefetch" href="/assets/js/30.955ad667.js"><link rel="prefetch" href="/assets/js/31.064ef281.js"><link rel="prefetch" href="/assets/js/32.5f88d44e.js"><link rel="prefetch" href="/assets/js/33.2fc19e88.js"><link rel="prefetch" href="/assets/js/34.5a0d2a6b.js"><link rel="prefetch" href="/assets/js/35.1b99631d.js"><link rel="prefetch" href="/assets/js/36.c1fb9a25.js"><link rel="prefetch" href="/assets/js/37.7643d68e.js"><link rel="prefetch" href="/assets/js/38.9c71544d.js"><link rel="prefetch" href="/assets/js/39.9b77b86d.js"><link rel="prefetch" href="/assets/js/40.5770bcf5.js"><link rel="prefetch" href="/assets/js/41.04fc2396.js"><link rel="prefetch" href="/assets/js/42.b92ed718.js"><link rel="prefetch" href="/assets/js/43.93eeb3e4.js"><link rel="prefetch" href="/assets/js/44.6a23f7e7.js"><link rel="prefetch" href="/assets/js/45.b78c673a.js"><link rel="prefetch" href="/assets/js/46.35027471.js"><link rel="prefetch" href="/assets/js/47.0838f5cd.js"><link rel="prefetch" href="/assets/js/48.2ae7bad5.js"><link rel="prefetch" href="/assets/js/49.23d9b4d7.js"><link rel="prefetch" href="/assets/js/5.1f904404.js"><link rel="prefetch" href="/assets/js/50.10ec8c3f.js"><link rel="prefetch" href="/assets/js/51.415c8ea0.js"><link rel="prefetch" href="/assets/js/52.0a86f5b4.js"><link rel="prefetch" href="/assets/js/53.4d1c72cb.js"><link rel="prefetch" href="/assets/js/54.1af5a13e.js"><link rel="prefetch" href="/assets/js/55.27d5b373.js"><link rel="prefetch" href="/assets/js/6.1aed2db1.js"><link rel="prefetch" href="/assets/js/7.efa58335.js"><link rel="prefetch" href="/assets/js/8.0c59f90a.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.2352b21b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.5ee86e3d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">洋子的自留地 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/" class="nav-link">首页</a></li><li class="nav-item"><a href="/tag/" class="nav-link">标签</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">洋子的自留地 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">首页</a></li><li class="mobile-nav-item"><a href="/tag/" class="nav-link">标签</a></li> <li class="mobile-nav-item"><a href="/rss.xml" class="feed"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        使用 TensorFlow 识别简单图像验证码
      </h1> <div class="post-meta"><div itemprop="publisher author" itemtype="http://schema.org/Person" itemscope="itemscope" class="post-meta-author"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-navigation"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg> <span itemprop="name">洋子</span> <!----></div> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2017-12-03T00:00:00.000Z">
      2017-12-03
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-42ccfcd5><a href="/tag/机器学习" data-v-42ccfcd5><span data-v-42ccfcd5>机器学习</span></a></li><li class="post-tag" data-v-42ccfcd5><a href="/tag/TensorFlow" data-v-42ccfcd5><span data-v-42ccfcd5>TensorFlow</span></a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><p>公司有一个业务需要抓取某网站数据，登录需要识别验证码，类似下面这种，这应该是很多网站使用的验证码类型。</p> <p><img alt="" data-src="data:image/png;base64,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L/kMi99XTHW3U5VrzG+2eXnpSWZmSvY99reQRbj2LFVW4CGJqSgdw0V7/pJDPixlA2ZO3A6FoJ0q/KhAH+lzy59ciWWgIxqOtGXDk4PBgE6nMzncSUxRlI0ErgxCCSrAsWwQkne87/cpioIvffFeFCAw1OOUlu+RjyPswGU0GtIKp4mSHMezGSWw65QzaLVDhLJI44jFg0+hJofpwIE4ymgFDmUJeQ3Kadp8QorC5TfeegO+vQNjKgajF/n6N/4MJUDTQ2FIoy4tRzZCyYaBBceAy27fjb19geVoSFUZgrHg85dezhzQBYih48MwyQg8hyKJCTyfqqrQWiMAY4yhrmuklBMSq5CWwgC2VqA18TjGUgoBlFmGYzvkWYbtrutUuU4p1MclA6bhTSxhY7kuRZoQdtocPHCA2Znp4zaC19vXHJ8QNO1QgKBAUiOMc/x7IJdNeacTMbm+Bj15JeFNrhuHzuOuN2BZFhqaM4Vt21RVxcrKCvPz88d1UFmxtLSEp9TGc47TdATbdeB/ca5eM5emKWmaYky+EfQkSdiyZQvD4ZCqqn7AZhLfN4B1/Mdesxt7Mtr8aMjzHKUUxhiUUgittUnTFKWaJW3atImDBw+Spilzc3MbhlmWNdJWa8qypCgKgI3gvBGkbHbW6/UIw5A8z/F9nziOcRxng8x+Ulhf33rJIKU0a2trxhhjXnjhBSOEMOvI89wcOnTIGGNMkiQb82VZmv8r8jw3vV5v4348HhtjjImi6Efy8+NCv983RVGYuq4NzYvNhkOSJMHzPLIsw3VdBoMBYRi+LppZliGEaDT/RO6up/wbYT3zer3exksYaGSy1vqH2v+4sb4+ACFEwyHQ1JIQAtd1AQjDcKPmDx8+zMLCwkbJrCNN043n3wjD4ZAwDAmCANu2KYqCJEk2gv3aBf2kUBQFa2trzMzMgNbaAMZxnPWmYMIw3Pi8Plqt1uvuLcsynuf9wHP/c7zW17oPKaWZnZ39obb/n2Pbtm0GMP8NsFgYMN+kKoIAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDUtMDVUMDk6MjA6MDArMDg6MDCdpLKlAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTA1LTA1VDA5OjIwOjAwKzA4OjAw7PkKGQAAAE50RVh0c29mdHdhcmUASW1hZ2VNYWdpY2sgNi45LjEtMTAgUTE2IHg4Nl82NCAyMDE4LTA0LTE5IGh0dHA6Ly93d3cuaW1hZ2VtYWdpY2sub3JnQzCyggAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABd0RVh0VGh1bWI6OkltYWdlOjpIZWlnaHQAMjNG6PkjAAAAFnRFWHRUaHVtYjo6SW1hZ2U6OldpZHRoADY4TfklIgAAABl0RVh0VGh1bWI6Ok1pbWV0eXBlAGltYWdlL3BuZz+yVk4AAAAXdEVYdFRodW1iOjpNVGltZQAxNTI1NDgzMjAwkU8ZKwAAABN0RVh0VGh1bWI6OlNpemUAMy40NktCQjMVaIQAAABCdEVYdFRodW1iOjpVUkkAZmlsZTovLy90bXAvaW1hZ2VsYy9pbWd2aWV3Ml83XzE1MjUyNDA3MzE4ODUwMDc3Xzg1X1swXVO9CsoAAAAASUVORK5CYII=" loading="lazy" class="lazy"></p> <p>首先由于验证码比较简单，图像不复杂，而且全部是数字。于是试着采用传统方式，按照网上教程自己简单改了一个，使用 PHP 识别。大概流程就是切割二值化去噪等预处理，然后用字符串数组形式保存起来，识别传来的图片同样预处理后比较字符串的相似度，选出一个相识度最高的分类。识别率不是很理想（验证码比较简单，应该能优化得更好），隐约记得只能超过60%。</p> <p>因为识别效果不理想，目标网站登录状态还是能保持很久，没必要花太多精力在这上面，于是找了一个人工打码服务。简直太便宜了，一个月花不了多少钱，效果还好，只是有时候延迟比较高。反正对于我们的业务来说是足够用了。</p> <p>机器学习大潮来临，我寻思着能不能用在这上面，于是参考 TensorFlow 识别手写数字教程，开始照猫画虎。</p> <p>本文描述的只是作为一个普通开发者的一些粗浅理解，<strong>所有的代码和数据均在文后的 GitHub 有存留</strong>，建议结合代码阅读本文。如果有什么理解错误或 Bug 欢迎留言交流 ^_^</p> <h2 id="tensorflow-是什么"><a href="#tensorflow-是什么" class="header-anchor">#</a> TensorFlow 是什么</h2> <p>TensorFlow 是谷歌出的一款机器学习框架。看名字，TensorFlow 就是“张量流”。呃。。什么是张量呢？张量我的理解就是数据。张量有自己的形状，比如 0 阶张量是标量，1 阶是向量，2 阶是矩阵。。。所以在后文我们会看到在 TensorFlow 里面使用的量几乎都要定义其形状，因为它们都是张量。</p> <p>我们可以把 TensorFlow 看作一个黑盒子，里面有一些架好的管道，喂给他一些“张量”，他吐出一些“张量”，吐出的东西就是我们需要的结果。</p> <p><strong>所以我们需要确定喂进去的是什么，吐出来的是什么，管道如何搭建。</strong></p> <p>更多的入门概念可以查看这个 <a href="https://keras-cn.readthedocs.io/en/latest/for_beginners/concepts/" target="_blank" rel="noopener noreferrer">keras新手指南 » 一些基本概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="为什么使用-tensorflow"><a href="#为什么使用-tensorflow" class="header-anchor">#</a> 为什么使用 TensorFlow</h2> <p>没别的什么原因，只是因为谷歌大名，也没想更多。先撸起袖子干起来。如果为了快速成型，我建议可以看一下 <em>Keras</em>，号称为人类设计的机器学习框架，也就是用户体验友好，提供好几个机器学习框架更高层的接口。</p> <h2 id="大体流程"><a href="#大体流程" class="header-anchor">#</a> 大体流程</h2> <ol><li>抓取验证码</li> <li>给验证码打标签</li> <li>图片预处理</li> <li>保存数据集</li> <li>构建模型训练</li> <li>提取模型使用</li></ol> <h2 id="抓取验证码"><a href="#抓取验证码" class="header-anchor">#</a> 抓取验证码</h2> <p>这个简单，随便什么方式，循环下载一大堆，这里不再赘述。我这里下载了 750 张验证码，用 500 张做训练，剩下 250 张验证模型效果。</p> <p><img alt="" data-src="/assets/img/b0e70a48.b0e70a48.png" loading="lazy" class="lazy"></p> <h2 id="给验证码打标签"><a href="#给验证码打标签" class="header-anchor">#</a> 给验证码打标签</h2> <p>这里的验证码有750张之巨，要是手工给每个验证码打标签，那一定累尿了。这时候就可以使用人工打码服务，用廉价劳动力帮我们做这件事。人工打码后把识别结果保存下来。这里的代码就不提供了，看你用哪家的验证码服务，相信聪明的你一定能解决 😃</p> <p><img alt="" data-src="/assets/img/6bf246e3.6bf246e3.png" loading="lazy" class="lazy"></p> <h2 id="图片预处理"><a href="#图片预处理" class="header-anchor">#</a> 图片预处理</h2> <ol><li><strong>图片信息：</strong> 此验证码是 68x23，JPG格式</li> <li><strong>二值化：</strong> 我确信这个验证码足够简单，在丢失图片的颜色信息后仍然能被很好的识别。并且可以降低模型复杂度，因此我们可以将图片二值化。即只有两个颜色，全黑或者全白。</li> <li><strong>切割验证码：</strong> 观察验证码，没有特别扭曲或者粘连，所以我们可以把验证码平均切割成4块，分别识别，这样图片识别模型就只需要处理10个分类（如果有字母那将是36个分类而已）由于验证码外面有一圈边框，所以顺带把边框也去掉了。</li> <li><strong>处理结果：</strong> 16x21，黑白2位</li></ol> <p>相关 Python 代码如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'L'</span><span class="token punctuation">)</span> <span class="token comment"># 读取图片并灰度化</span>

img <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 裁掉边变成 64x21</span>

<span class="token comment"># 分离数字</span>
img1 <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
img2 <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
img3 <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
img4 <span class="token operator">=</span> img<span class="token punctuation">.</span>crop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

img1 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img1<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 扁平化，把二维弄成一维</span>
img1 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x <span class="token operator">&lt;=</span> <span class="token number">180</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> img1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 二值化</span>
img2 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
img2 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x <span class="token operator">&lt;=</span> <span class="token number">180</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> img2<span class="token punctuation">)</span><span class="token punctuation">)</span>
img3 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img3<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
img3 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x <span class="token operator">&lt;=</span> <span class="token number">180</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> img3<span class="token punctuation">)</span><span class="token punctuation">)</span>
img4 <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img4<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
img4 <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> <span class="token number">1</span> <span class="token keyword">if</span> x <span class="token operator">&lt;=</span> <span class="token number">180</span> <span class="token keyword">else</span> <span class="token number">0</span><span class="token punctuation">,</span> img4<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h2 id="保存数据集"><a href="#保存数据集" class="header-anchor">#</a> 保存数据集</h2> <p>数据集有输入输入数据和标签数据，训练数据和测试数据。<br>
因为数据量不大，简便起见，直接把数据存成python文件，供模型调用。就不保存为其他文件，然后用 <em>pandas</em> 什么的来读取了。</p> <p>最终我们的输入模型的数据形状为 <strong>[[0,1,0,1,0,1,0,1...],[0,1,0,1,0,1,0,1...],...]</strong><br>
标签数据很特殊，本质上我们是对输入的数据进行分类，所以虽然标签应该是0到9的数字，但是这里我们使标签数据格式是 <em>one-hot vectors</em> <strong>[[1,0,0,0,0,0,0,0,0,0,0],...]</strong><br>
一个one-hot向量除了某一位的数字是1以外其余各维度数字都是0**，比如[1,0,0,0,0,0,0,0,0,0] 代表1，[0,1,0,0,0,0,0,0,0,0]代表2.<br>
更进一步，这里的 one-hot 向量其实代表着对应的数据分成这十类的概率。概率为1就是正确的分类。</p> <p>相关 Python 代码如下：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token comment"># 保存输入数据</span>
<span class="token keyword">def</span> <span class="token function">px</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> img3<span class="token punctuation">,</span> img4<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./data/'</span> <span class="token operator">+</span> prefix <span class="token operator">+</span> <span class="token string">'_images.py'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;,\n&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;,\n&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img3<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;,\n&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>img4<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;,\n&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 保存标签数据</span>
<span class="token keyword">def</span> <span class="token function">py</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./data/'</span> <span class="token operator">+</span> prefix <span class="token operator">+</span> <span class="token string">'_labels.py'</span><span class="token punctuation">,</span> <span class="token string">'a+'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            tmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
            tmp<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>code<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token operator">=</span>f<span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">&quot;,\n&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>经过上面两步，我们在就获得了训练和测试用的数据和标签数据，呐，就像这样</p> <p><img alt="" data-src="/assets/img/1038f9db.1038f9db.png" loading="lazy" class="lazy"></p> <h2 id="构建模型训练"><a href="#构建模型训练" class="header-anchor">#</a> 构建模型训练</h2> <p>数据准备好啦，到了要搭建“管道”的时候了。<br>
也就是你需要告诉 TensorFlow：</p> <h3 id="_1-输入数据的形状是怎样的"><a href="#_1-输入数据的形状是怎样的" class="header-anchor">#</a> 1. 输入数据的形状是怎样的？</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code>x <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> DLEN<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>None 表示不定义我们有多少训练数据，DLEN是 16*21，即一维化的图片的大小。</p> <h3 id="_2-输出数据的形状是怎样的"><a href="#_2-输出数据的形状是怎样的" class="header-anchor">#</a> 2. 输出数据的形状是怎样的？</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code>y_ <span class="token operator">=</span> tf<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token string">&quot;float&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>同样None 表示不定义我们有多少训练数据，10 就是标签数据的维度，即图片有 10 个分类。每个分类对应着一个概率，所以是浮点类型。</p> <h3 id="_3-输入数据-模型-标签数据怎样拟合"><a href="#_3-输入数据-模型-标签数据怎样拟合" class="header-anchor">#</a> 3. 输入数据，模型，标签数据怎样拟合？</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code>W <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span>DLEN<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 权重</span>
b <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 偏置</span>

y <span class="token operator">=</span> tf<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>x<span class="token punctuation">,</span> W<span class="token punctuation">)</span> <span class="token operator">+</span> b<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>是不是一个很简单的模型？大体就是<br> <strong>y = softmax(Wx+b)</strong><br>
其中 W 和 b 是 TensorFlow 中的变量，他们保存着模型在训练过程中的数据，需要定义出来。而我们模型训练的目的，也就是把 W 和 b 的值确定，使得这个式子可以更好的拟合数据。<br> <em>softmax</em> 是所谓的激活函数，把线性的结果转换成我们需要的样式，也就是分类概率的分布。<br>
关于 <em>softmax</em> 之类更多解释请查看参考链接。</p> <h3 id="_4-怎样评估模型的好坏"><a href="#_4-怎样评估模型的好坏" class="header-anchor">#</a> 4. 怎样评估模型的好坏？</h3> <p>模型训练就是为了使模型输出结果和实际情况相差尽可能小。所以要定义评估方式。<br>
这里用所谓的<em>交叉熵</em>来评估。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>cross_entropy <span class="token operator">=</span> <span class="token operator">-</span>tf<span class="token punctuation">.</span>reduce_sum<span class="token punctuation">(</span>y_<span class="token operator">*</span>tf<span class="token punctuation">.</span>log<span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="_5-怎样最小化误差"><a href="#_5-怎样最小化误差" class="header-anchor">#</a> 5. 怎样最小化误差？</h3> <p>现在 TensorFlow 已经知道了足够的信息，它要做的工作就是让模型的误差足够小，它会使出各种方法使上面定义的交叉熵 <em>cross_entropy</em> 变得尽可能小。<br>
TensorFlow 内置了不少方式可以达到这个目的，不同方式有不同的特点和适用条件。在这里使用梯度下降法来实现这个目的。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>train_step <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>GradientDescentOptimizer<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>minimize<span class="token punctuation">(</span>cross_entropy<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="训练准备"><a href="#训练准备" class="header-anchor">#</a> 训练准备</h3> <p>大家知道 Python 作为解释型语言，运行效率不能算是太好，而这种机器学习基本是需要大量计算力的场合。TensorFlow 在底层是用 C++ 写就，在 Python 端只是一个操作端口，所有的计算都要交给底层处理。这自然就引出了<strong>会话</strong>的概念，底层和调用层需要通信。也正是这个特点，TensorFlow 支持很多其他语言接入，如 Java, C，而不仅仅是 Python。<br>
和底层通信是通过会话完成的。我们可以通过一行代码来启动会话：</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>sess <span class="token operator">=</span> tf<span class="token punctuation">.</span>Session<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 代码...</span>
sess<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>别忘了在使用完后关闭会话。当然你也可以使用 Python 的 <em>with</em> 语句来自动管理。</p> <p>在 TensorFlow 中，变量都是需要在会话启动之后初始化才能使用。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>global_variables_initializer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="开始训练"><a href="#开始训练" class="header-anchor">#</a> 开始训练</h3> <div class="language-python line-numbers-mode"><pre class="language-python"><code><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>DNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
    batch_xs <span class="token operator">=</span> <span class="token punctuation">[</span>train_images<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
    batch_ys <span class="token operator">=</span> <span class="token punctuation">[</span>train_labels<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span>
    sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>train_step<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>x<span class="token punctuation">:</span> batch_xs<span class="token punctuation">,</span> y_<span class="token punctuation">:</span> batch_ys<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们把模型和训练数据交给会话，底层就自动帮我们处理啦。<br>
我们可以一次传入任意数量数据给模型（上面设置None的作用），为了训练效果，可以适当调节每一批次训练的数据。甚至于有时候还要随机选择数据以获得更好的训练效果。在这里我们就一条一条训练了，反正最后效果还可以。要了解更多可以查看参考链接。</p> <h3 id="检验训练结果"><a href="#检验训练结果" class="header-anchor">#</a> 检验训练结果</h3> <p>这里我们的测试数据就要派上用场了</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>correct_prediction <span class="token operator">=</span> tf<span class="token punctuation">.</span>equal<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>y_<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>correct_prediction<span class="token punctuation">,</span> <span class="token string">&quot;float&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>sess<span class="token punctuation">.</span>run<span class="token punctuation">(</span>accuracy<span class="token punctuation">,</span> feed_dict<span class="token operator">=</span><span class="token punctuation">{</span>x<span class="token punctuation">:</span> test_images<span class="token punctuation">.</span>data<span class="token punctuation">,</span> y_<span class="token punctuation">:</span> test_labels<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们模型输出是一个数组，里面存着每个分类的概率，所以我们要拿出概率最大的分类和测试标签比较。看在这 250 条测试数据里面，正确率是多少。当然这些也是定义完操作步骤，交给会话来运行处理的。<br> <img alt="" data-src="/assets/img/fc3ad258.fc3ad258.png" loading="lazy" class="lazy"></p> <h2 id="提取模型使用"><a href="#提取模型使用" class="header-anchor">#</a> 提取模型使用</h2> <p>在上面我们已经把模型训练好了，而且效果还不错哦，近 99% 的正确率，或许比人工打码还高一些呢（获取测试数据时候常常返回有错误的值）。但是问题来了，我现在要把这个模型用于生产怎么办，总不可能每次都训练一次吧。在这里，我们就要使用到 TensorFlow 的模型保存和载入功能了。</p> <h3 id="保存模型"><a href="#保存模型" class="header-anchor">#</a> 保存模型</h3> <p>先在模型训练的时候保存模型，定义一个 saver，然后直接把会话保存到一个目录就好了。</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>saver <span class="token operator">=</span> tf<span class="token punctuation">.</span>train<span class="token punctuation">.</span>Saver<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 训练代码</span>
<span class="token comment"># ...</span>
saver<span class="token punctuation">.</span>save<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> <span class="token string">'model/model'</span><span class="token punctuation">)</span>
sess<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>当然这里的 saver 也有不少配置，比如保存最近多少批次的训练结果之类，可以自行查资料。</p> <h2 id="恢复模型"><a href="#恢复模型" class="header-anchor">#</a> 恢复模型</h2> <p>同样恢复模型也很简单</p> <div class="language-python line-numbers-mode"><pre class="language-python"><code>saver<span class="token punctuation">.</span>restore<span class="token punctuation">(</span>sess<span class="token punctuation">,</span> <span class="token string">&quot;model/model&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当然你还是需要定义好模型，才能恢复。我的理解是这里模型保存的是训练过程中各个变量的值，权重偏置什么的，所以结构架子还是要事先搭好才行。<br> <img alt="" data-src="/assets/img/87df71be.87df71be.png" loading="lazy" class="lazy"></p> <h2 id="最后"><a href="#最后" class="header-anchor">#</a> 最后</h2> <p>这里只是展示了使用 TensorFlow 识别简单的验证码，效果还不错，上机器学习应该也不算是杀鸡用牛刀。毕竟模型无脑，节省很多时间。如果需要识别更加扭曲，更加变态的验证码，或许需要上卷积神经网络之类，图片结构和颜色信息都不能丢掉了。另一方面，做网站安全这块，纯粹的图形验证码恐怕不能作为判断是不是机器人的依据。对抗到最后，就变成这样的变态验证码哈哈哈。<br> <img alt="" data-src="/assets/img/b80859d4.b80859d4.gif" loading="lazy" class="lazy"></p> <h2 id="相关链接"><a href="#相关链接" class="header-anchor">#</a> 相关链接</h2> <ol><li><a href="https://github.com/purocean/tensorflow-simple-captcha" target="_blank" rel="noopener noreferrer">https://github.com/purocean/tensorflow-simple-captcha<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://keras-cn.readthedocs.io/en/latest/for_beginners/concepts/" target="_blank" rel="noopener noreferrer">https://keras-cn.readthedocs.io/en/latest/for_beginners/concepts/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="http://wiki.jikexueyuan.com/project/tensorflow-zh/" target="_blank" rel="noopener noreferrer">http://wiki.jikexueyuan.com/project/tensorflow-zh/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#tensorflow-是什么" title="TensorFlow 是什么">TensorFlow 是什么</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#为什么使用-tensorflow" title="为什么使用 TensorFlow">为什么使用 TensorFlow</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#大体流程" title="大体流程">大体流程</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#抓取验证码" title="抓取验证码">抓取验证码</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#给验证码打标签" title="给验证码打标签">给验证码打标签</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#图片预处理" title="图片预处理">图片预处理</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#保存数据集" title="保存数据集">保存数据集</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#构建模型训练" title="构建模型训练">构建模型训练</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-输入数据的形状是怎样的" title="1. 输入数据的形状是怎样的？">1. 输入数据的形状是怎样的？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-输出数据的形状是怎样的" title="2. 输出数据的形状是怎样的？">2. 输出数据的形状是怎样的？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-输入数据-模型-标签数据怎样拟合" title="3. 输入数据，模型，标签数据怎样拟合？">3. 输入数据，模型，标签数据怎样拟合？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-怎样评估模型的好坏" title="4. 怎样评估模型的好坏？">4. 怎样评估模型的好坏？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-怎样最小化误差" title="5. 怎样最小化误差？">5. 怎样最小化误差？</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#训练准备" title="训练准备">训练准备</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#开始训练" title="开始训练">开始训练</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#检验训练结果" title="检验训练结果">检验训练结果</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#提取模型使用" title="提取模型使用">提取模型使用</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#保存模型" title="保存模型">保存模型</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#恢复模型" title="恢复模型">恢复模型</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#最后" title="最后">最后</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#相关链接" title="相关链接">相关链接</a></div></div></div></div> <footer class="footer" data-v-3d9deeb8><div class="footer-left-wrap" data-v-3d9deeb8><ul class="contact" data-v-3d9deeb8><li class="contact-item" data-v-3d9deeb8><a href="https://github.com/purocean/blog" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-3d9deeb8><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-3d9deeb8></path></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-3d9deeb8><ul class="copyright" data-v-3d9deeb8><li class="copyright-item" data-v-3d9deeb8>Powered by VuePress | Copyright © 2019-present</li><li class="copyright-item" data-v-3d9deeb8><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-3d9deeb8>蜀ICP备2023032883号-1</a></li></ul></div></footer></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.eb9f9003.js" defer></script><script src="/assets/js/4.a919a368.js" defer></script><script src="/assets/js/1.b0bbcc77.js" defer></script><script src="/assets/js/16.846050e5.js" defer></script>
  </body>
</html>
